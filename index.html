<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Planner Dashboard - Student Edition</title>
    
    <!-- Fontes e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8c2bee",
                        "background-dark": "#191022",
                        "glass": "rgba(255, 255, 255, 0.05)",
                        "glass-strong": "rgba(255, 255, 255, 0.1)",
                    },
                    fontFamily: { "display": ["Plus Jakarta Sans", "sans-serif"] },
                    backgroundImage: { 'dot-pattern': 'radial-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px)' },
                    backgroundSize: { 'dot-size': '20px 20px' }
                },
            },
        }
    </script>

    <style>
        :root { color-scheme: dark; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .neon-border-wrapper {
            background: linear-gradient(45deg, #ff7eb3, #8c2bee, #00d4ff);
            padding: 1px;
            border-radius: 0.75rem;
        }

        #ink-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 40;
            pointer-events: none;
            touch-action: none;
        }

        body.pen-mode #ink-canvas {
            pointer-events: auto;
            cursor: crosshair;
        }

        .view-content { display: none; height: auto; min-height: 100%; }
        .view-content.active { display: block; }

        input[type="text"], input[type="date"], input[type="email"], input[type="password"], textarea {
            background-color: transparent !important;
            color: #ffffff !important;
            border: none;
            outline: none;
        }
        input::placeholder, textarea::placeholder { color: rgba(255, 255, 255, 0.4) !important; }

        .dash-input {
            background: transparent !important;
            border: none !important;
            border-bottom: 1px solid rgba(255,255,255,0.1) !important;
            color: #ffffff !important;
            width: 100%;
            padding: 4px 0;
            outline: none;
        }

        .sidebar-transition {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .alert-card-sidebar {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #8c2bee;
            padding: 12px;
            border-radius: 0 12px 12px 0;
            margin-bottom: 10px;
        }

        .calendar-day-num {
            color: #ffffff !important;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .bottom-nav-transition {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }
        .nav-hidden {
            transform: translate(-50%, 150%) !important;
            opacity: 0;
            pointer-events: none;
        }
        .content-expanded { padding-bottom: 2rem !important; }

        #auth-overlay {
            position: fixed;
            inset: 0;
            background: #191022;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        #sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #sync-indicator.active { opacity: 1; }
    </style>
</head>

<body class="bg-background-dark font-display text-white antialiased selection:bg-primary selection:text-white overflow-hidden">
    
    <!-- Sincroniza√ß√£o -->
    <div id="sync-indicator" class="flex items-center gap-2 bg-primary/20 backdrop-blur-xl px-3 py-1.5 rounded-full border border-primary/30">
        <span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>
        <span class="text-[9px] font-black uppercase tracking-widest">Sincronizando</span>
    </div>

    <!-- TELA DE LOGIN / CADASTRO -->
    <div id="auth-overlay">
        <div class="fixed inset-0 pointer-events-none z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[40%] rounded-full bg-primary/20 blur-[100px]"></div>
            <div class="absolute bottom-[20%] right-[-5%] w-[40%] h-[40%] rounded-full bg-pink-500/10 blur-[100px]"></div>
        </div>
        
        <div class="auth-card glass-panel relative z-10 text-center">
            <div class="mb-8">
                <div class="bg-center bg-no-repeat bg-cover rounded-full h-20 w-20 ring-2 ring-primary/50 shadow-xl mx-auto mb-4" style='background-image: url("https://avatarfiles.alphacoders.com/374/374567.png");'></div>
                <h2 class="text-2xl font-bold tracking-tight mb-2 text-white">Planner OS</h2>
                <p class="text-white/40 text-sm" id="auth-subtitle">Entre para acessar seu dashboard</p>
            </div>

            <div class="space-y-4" id="auth-form">
                <div class="text-left">
                    <label class="text-[10px] font-black text-primary uppercase ml-4 mb-1 block">Email</label>
                    <input type="email" id="email" placeholder="email@exemplo.com" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-primary/50 transition-all text-white"/>
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-black text-primary uppercase ml-4 mb-1 block">Senha</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-primary/50 transition-all text-white"/>
                </div>
                
                <button onclick="handleAuth()" id="main-auth-btn" class="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all mt-4">Entrar</button>
                
                <p class="text-xs text-white/40 mt-6">
                    <span id="auth-switch-text">N√£o tem uma conta?</span>
                    <button onclick="toggleAuthMode()" id="auth-switch-btn" class="text-primary font-bold ml-1 hover:underline">Cadastrar-se</button>
                </p>
            </div>
            
            <div id="auth-error" class="mt-4 text-xs text-rose-400 font-bold hidden"></div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-container" class="relative h-screen w-full flex flex-col hidden">
        <div class="fixed inset-0 pointer-events-none z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[40%] rounded-full bg-primary/20 blur-[100px]"></div>
            <div class="absolute bottom-[20%] right-[-5%] w-[40%] h-[40%] rounded-full bg-pink-500/10 blur-[100px]"></div>
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0"></div>
        <aside id="sidebar" class="sidebar-transition fixed top-0 left-0 h-full w-[320px] bg-[#1a1122]/95 backdrop-blur-2xl z-[80] transform -translate-x-full border-r border-white/5 p-6 overflow-y-auto hide-scrollbar shadow-2xl">
            <div class="flex justify-between items-center mb-8 text-white">
                <h2 class="text-xl font-bold tracking-tight">Status Global</h2>
                <div class="flex gap-2">
                    <button onclick="logout()" class="material-symbols-outlined text-sm opacity-50 hover:text-rose-400">logout</button>
                    <button onclick="toggleSidebar()" class="material-symbols-outlined opacity-50">close</button>
                </div>
            </div>
            <div class="space-y-8">
                <section><p class="text-[10px] font-black text-primary uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-sm">target</span> Prioridades</p><div id="sidebar-priorities-content" class="space-y-3"></div></section>
                <section><p class="text-[10px] font-black text-pink-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-sm">event</span> Radar</p><div id="sidebar-radar-content" class="space-y-3"></div></section>
                <section><p class="text-[10px] font-black text-rose-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-sm">warning</span> Riscos</p><div id="sidebar-risks-content" class="space-y-3"></div></section>
            </div>
        </aside>

        <!-- Header -->
        <header class="relative z-50 flex p-6 items-center justify-between shrink-0">
            <div class="flex gap-4 items-center">
                <div class="relative">
                    <button onclick="toggleSidebar()" class="absolute -top-1 -left-1 z-10 bg-primary h-6 w-6 rounded-full flex items-center justify-center border-2 border-[#1a1122] shadow-lg"><span class="material-symbols-outlined text-[14px] text-white">menu</span></button>
                    <div class="bg-center bg-no-repeat bg-cover rounded-full h-14 w-14 ring-2 ring-primary/50 shadow-lg" style='background-image: url("https://avatarfiles.alphacoders.com/374/374567.png");'></div>
                </div>
                <div><p class="text-white/60 text-xs font-medium tracking-wider uppercase" id="header-day-label">CARREGANDO...</p><p class="text-white text-xl font-bold leading-tight">Min-ji</p></div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleBottomNav()" class="glass-panel p-3 rounded-full transition-all hover:bg-white/10 ring-1 ring-white/5"><span class="material-symbols-outlined text-white" id="nav-toggle-icon">visibility</span></button>
                <button onclick="togglePenMode()" id="pen-toggle" class="glass-panel p-3 rounded-full transition-all hover:bg-white/10 ring-1 ring-white/5"><span class="material-symbols-outlined text-white" id="pen-icon">edit_off</span></button>
                <button onclick="generateScreenshot()" class="glass-panel p-3 rounded-full transition-all hover:bg-white/10 ring-1 ring-white/5"><span class="material-symbols-outlined text-white">photo_camera</span></button>
            </div>
        </header>

        <!-- Radar -->
        <div class="relative z-10 flex flex-col gap-2 mb-2 shrink-0">
            <div class="px-6"><h3 class="text-white/90 text-[10px] font-bold tracking-[0.2em] flex items-center gap-2"><span class="material-symbols-outlined text-pink-400 text-[16px]">local_florist</span> ATTENTION RADAR</h3></div>
            <div class="flex overflow-x-auto hide-scrollbar px-6 py-2 gap-4 pb-4" id="radar-container"></div>
        </div>

        <!-- Main Content -->
        <div class="relative z-10 flex-1 glass-panel rounded-t-[2.5rem] mt-2 border-b-0 border-x-0 mx-2 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col overflow-hidden">
            <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-white/10 rounded-full z-50"></div>
            <div class="flex-1 overflow-y-auto hide-scrollbar px-6 pt-8 pb-32 relative transition-all duration-500" id="main-scroll-area">
                <canvas id="ink-canvas"></canvas>

                <!-- VIEW: DAILY -->
                <div id="view-daily" class="view-content active space-y-10 relative z-10">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 glass-panel px-3 py-1 rounded-full ring-1 ring-white/5">
                            <button onclick="changeDay(-1)" class="material-symbols-outlined text-sm text-white">chevron_left</button>
                            <input type="date" id="daily-date" class="bg-transparent border-none text-[10px] font-bold p-0 text-white" onchange="loadDayFromInput()"/>
                            <button onclick="changeDay(1)" class="material-symbols-outlined text-sm text-white">chevron_right</button>
                        </div>
                        <button onclick="resetDaily()" class="text-[9px] font-bold text-red-400/60 uppercase tracking-widest">üóëÔ∏è Reset Day</button>
                    </div>
                    <section><h3 class="text-white text-base font-bold flex items-center gap-2 mb-4"><span class="w-1.5 h-5 rounded-full bg-gradient-to-b from-primary to-pink-500 block"></span> Prioridades de Hoje</h3><div class="flex flex-col gap-3" id="daily-priorities"></div></section>
                    <section><div class="flex justify-between items-center mb-4"><h3 class="text-white text-base font-bold flex items-center gap-2 text-white"><span class="w-1.5 h-5 rounded-full bg-gradient-to-b from-blue-500 to-cyan-400 block"></span> Cronograma Din√¢mico</h3><button onclick="addTimelineSlotPrompt()" class="bg-primary/20 text-primary text-[9px] px-4 py-1.5 rounded-full font-black border border-primary/30 uppercase tracking-widest">+ Add Task</button></div><div class="relative pl-4 border-l border-white/10 space-y-6" id="daily-flow"></div></section>
                </div>

                <!-- VIEW: CONTEXTS -->
                <div id="view-contexts" class="view-content space-y-8 relative z-10">
                    <div class="flex justify-between items-center text-white"><h3 class="text-white text-lg font-bold flex items-center gap-2"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-pink-500 to-rose-600 block"></span> Listas de Contexto</h3><button onclick="clearDoneContexts()" class="text-[9px] font-bold text-primary/60 uppercase tracking-widest">Limpar Feitos</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-rose-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üî• Urgente</p><div id="ctx-imp_urg" class="space-y-2"></div><button onclick="addContextItem('imp_urg')" class="mt-4 text-[10px] opacity-40 font-bold uppercase text-white">+ Novo</button></div>
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üìÖ Importante</p><div id="ctx-imp_not_urg" class="space-y-2"></div><button onclick="addContextItem('imp_not_urg')" class="mt-4 text-[10px] opacity-40 font-bold uppercase text-white">+ Novo</button></div>
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-blue-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üõçÔ∏è Compras</p><div id="ctx-compras" class="space-y-2"></div><button onclick="addContextItem('compras')" class="mt-4 text-[10px] opacity-40 font-bold uppercase text-white">+ Novo</button></div>
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-emerald-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üè† Pessoal</p><div id="ctx-casa" class="space-y-2"></div><button onclick="addContextItem('casa')" class="mt-4 text-[10px] opacity-40 font-bold uppercase text-white">+ Novo</button></div>
                    </div>
                </div>

                <!-- VIEW: PROJECTS -->
                <div id="view-projects" class="view-content space-y-8 relative z-10 text-white"><h3 class="text-white text-lg font-bold flex items-center gap-2"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-yellow-400 to-orange-500 block"></span> Roadmap 2026</h3><div id="projects-list" class="space-y-3"></div><button onclick="addNewProject()" class="w-full py-4 rounded-2xl border border-dashed border-white/10 text-white/30 text-xs font-bold hover:bg-white/5 transition-all uppercase tracking-widest">+ New Objective</button></div>

                <!-- VIEW: BRAIN DUMP -->
                <div id="view-dump" class="view-content relative z-10"><h3 class="text-white text-lg font-bold flex items-center gap-2 text-white"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-green-400 to-emerald-600 block"></span> Brain Dump</h3><div class="w-full h-80 bg-white/5 rounded-3xl p-6 border border-white/10 bg-dot-pattern bg-dot-size relative group"><textarea id="brain-dump-text" class="w-full h-full bg-transparent border-none resize-none focus:ring-0 text-sm text-white/80 leading-relaxed" placeholder="Anote qualquer pensamento aqui..." oninput="updateDumpText(this.value)"></textarea></div></div>

                <!-- VIEW: MONTHLY -->
                <div id="view-monthly" class="view-content space-y-6 relative z-10">
                    <div class="flex justify-between items-center mb-2"><h3 class="text-white text-lg font-bold flex items-center gap-2 text-white"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-pink-500 to-rose-600 block"></span> Agenda Mensal</h3><div class="flex items-center gap-4 bg-white/5 px-4 py-2 rounded-full border border-white/10"><button onclick="changeMonth(-1)" class="material-symbols-outlined text-white hover:text-primary">chevron_left</button><span id="month-title" class="text-sm font-black uppercase tracking-widest text-white min-w-[150px] text-center">---</span><button onclick="changeMonth(1)" class="material-symbols-outlined text-white hover:text-primary">chevron_right</button></div></div>
                    <div id="month-header" class="grid grid-cols-7 gap-1"><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">DOM</div><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">SEG</div><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">TER</div><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">QUA</div><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">QUI</div><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">SEX</div><div class="text-center text-[10px] font-black opacity-30 p-2 text-white">SAB</div></div>
                    <div id="month-grid" class="grid grid-cols-7 gap-1 border border-white/10 rounded-2xl overflow-hidden shadow-2xl"></div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav id="bottom-nav" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[60] bottom-nav-transition">
            <div class="glass-panel rounded-3xl p-2 flex justify-between items-center shadow-2xl shadow-primary/30 ring-1 ring-white/10">
                <button onclick="nav('daily')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl transition-all" id="btn-daily"><span class="material-symbols-outlined text-[20px]">calendar_view_day</span><span class="text-[9px] font-bold uppercase tracking-tighter">Di√°rio</span></button>
                <button onclick="nav('contexts')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl text-white/40" id="btn-contexts"><span class="material-symbols-outlined text-[20px]">list_alt</span><span class="text-[9px] font-bold uppercase tracking-tighter">Listas</span></button>
                <div class="relative -top-8 mx-2"><button onclick="nav('dump')" class="h-16 w-16 rounded-full bg-gradient-to-tr from-pink-500 to-primary flex items-center justify-center shadow-2xl border-4 border-[#191022] hover:scale-105 transition-all"><span class="material-symbols-outlined text-white text-[32px]">psychology</span></button></div>
                <button onclick="nav('projects')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl text-white/40" id="btn-projects"><span class="material-symbols-outlined text-[20px]">rocket_launch</span><span class="text-[9px] font-bold uppercase tracking-tighter">Roadmap</span></button>
                <button onclick="nav('monthly')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl text-white/40" id="btn-monthly"><span class="material-symbols-outlined text-[20px]">calendar_month</span><span class="text-[9px] font-bold uppercase tracking-tighter">Agenda</span></button>
            </div>
        </nav>
    </div>

    <script>
        // --- CREDENCIAIS ---
        const SUPABASE_URL = "https://xmbydwfxkbpcjmojtyvk.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_9cmC_iJS5VL6j_W_CetgXw_k-pf5gii";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isSignUpMode = false;
        let currentUser = null;
        let state;
        let viewDate = new Date();
        let saveTimeout = null;

        // --- AUTH ---
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');

            if(!email || !password) { showAuthError("Preencha todos os campos"); return; }

            let result;
            if(isSignUpMode) {
                result = await supabaseClient.auth.signUp({ email, password });
            } else {
                result = await supabaseClient.auth.signInWithPassword({ email, password });
            }

            if(result.error) {
                showAuthError(result.error.message);
            } else {
                if(isSignUpMode && !result.data.session) {
                    alert("Verifique seu e-mail para confirmar o cadastro!");
                    toggleAuthMode();
                } else {
                    checkSession();
                }
            }
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('main-auth-btn').innerText = isSignUpMode ? "Criar Conta" : "Entrar";
            document.getElementById('auth-subtitle').innerText = isSignUpMode ? "Crie seu acesso pessoal" : "Bem-vinda de volta, Min-ji";
            document.getElementById('auth-switch-text').innerText = isSignUpMode ? "J√° tem uma conta?" : "N√£o tem uma conta?";
            document.getElementById('auth-switch-btn').innerText = isSignUpMode ? "Entrar" : "Cadastrar-se";
        }

        function showAuthError(msg) {
            const errorEl = document.getElementById('auth-error');
            errorEl.innerText = msg;
            errorEl.classList.remove('hidden');
        }

        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if(session) {
                currentUser = session.user;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');
                await initApp();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('app-container').classList.add('hidden');
            }
        }

        async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

        // --- CORE STATE ---
        function getLocalTodayISO() {
            const now = new Date();
            const offset = now.getTimezoneOffset();
            return new Date(now.getTime() - (offset * 60 * 1000)).toISOString().split('T')[0];
        }

        async function initApp() {
            if(!currentUser) return;
            document.getElementById('header-day-label').innerText = "SINCRONIZANDO...";

            const { data, error } = await supabaseClient
                .from('user_settings')
                .select('full_state')
                .eq('user_id', currentUser.id)
                .single();

            if (data && data.full_state) {
                state = data.full_state;
                state.currentDateStr = getLocalTodayISO();
            } else {
                state = {
                    activeView: 'daily',
                    events: [],
                    projects: [
                        { id: 'p1', title: "Evolu√ß√£o Pessoal 2026", created: Date.now(), why: "Prop√≥sito", actions: [{text: "Definir metas", done: false, phases: []}] },
                        { id: 'risk', title: "Risco Procrastina√ß√£o", created: Date.now(), why: "A√ß√£o imediata", actions: [{text: "Tarefa cr√≠tica", done: false, phases: []}] }
                    ],
                    currentDateStr: getLocalTodayISO(),
                    dailyLogs: {},
                    inkData: {},
                    dump: "",
                    contexts: { casa:[], compras:[], adm:[], imp_urg:[], imp_not_urg:[] }
                };
            }
            lucide.createIcons();
            resizeCanvas();
            renderAll();
        }

        async function saveState() {
            if(!currentUser || !state) return;
            saveDrawingToState();
            document.getElementById('sync-indicator').classList.add('active');
            if(saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const { error } = await supabaseClient
                    .from('user_settings')
                    .upsert({ user_id: currentUser.id, full_state: state, updated_at: new Date() });
                if(error) console.error("Erro Supabase:", error);
                document.getElementById('sync-indicator').classList.remove('active');
                updateRadar();
            }, 800);
        }

        // --- UI & LOGIC (STYLUS, NAVEGA√á√ÉO, DAILY, RADAR, ROADMAP, CONTEXTS, CALENDARIO) ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            if (isOpen) { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
            else { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.add('opacity-100'), 10); updateRadar(); }
        }

        function toggleBottomNav() {
            const isHidden = document.getElementById('bottom-nav').classList.toggle('nav-hidden');
            document.getElementById('main-scroll-area').classList.toggle('content-expanded', isHidden);
            document.getElementById('nav-toggle-icon').innerText = isHidden ? "visibility_off" : "visibility";
        }

        function nav(viewId) {
            saveDrawingToState();
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white', 'shadow-lg'); b.classList.add('text-white/40'); });
            document.getElementById('view-' + viewId).classList.add('active');
            const btn = document.getElementById('btn-' + viewId);
            if(btn) { btn.classList.remove('text-white/40'); btn.classList.add('bg-primary', 'text-white', 'shadow-lg'); }
            state.activeView = viewId;
            renderAll();
            if(window.innerWidth < 1024 && !document.getElementById('sidebar').classList.contains('-translate-x-full')) toggleSidebar();
        }

        const canvas = document.getElementById('ink-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let penMode = false;

        function resizeCanvas() {
            const area = document.getElementById('main-scroll-area'); if(!area) return;
            canvas.width = area.clientWidth * 2; canvas.height = area.scrollHeight * 2;
            ctx.scale(2, 2); ctx.lineCap = 'round'; ctx.lineJoin = 'round'; loadDrawingFromState();
        }

        function togglePenMode() {
            penMode = !penMode; document.body.classList.toggle('pen-mode', penMode);
            document.getElementById('pen-icon').innerText = penMode ? "edit" : "edit_off";
            document.getElementById('pen-toggle').classList.toggle('bg-primary/40', penMode);
            if(!penMode) saveState();
        }

        canvas.addEventListener('pointerdown', (e) => { if(!penMode) return; isDrawing = true; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); });
        canvas.addEventListener('pointermove', (e) => { if(!isDrawing || !penMode) return; const rect = canvas.getBoundingClientRect(); ctx.lineWidth = e.pressure ? e.pressure * 5 : 2; ctx.strokeStyle = "#8c2bee"; ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); });
        canvas.addEventListener('pointerup', () => { isDrawing = false; saveState(); });

        function saveDrawingToState() { if(!state) return; state.inkData[state.activeView === 'daily' ? `ink_${state.currentDateStr}` : `ink_${state.activeView}`] = canvas.toDataURL(); }
        function loadDrawingFromState() { if(!state) return; const data = state.inkData[state.activeView === 'daily' ? `ink_${state.currentDateStr}` : `ink_${state.activeView}`]; ctx.clearRect(0, 0, canvas.width, canvas.height); if(data) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0, canvas.width/2, canvas.height/2); img.src = data; } }

        function ensureLog(dateStr) { if (!state.dailyLogs[dateStr]) { state.dailyLogs[dateStr] = { p1: "", p1_done: false, p2: "", p2_done: false, p3: "", p3_done: false, timeline: { "08:00": "Acordar", "10:00": "Foco Estudo", "13:00": "Almo√ßo", "15:00": "Revis√£o", "18:00": "Atividade Livre", "20:00": "Jantar", "22:00": "Planeamento", "23:00": "Descanso" } }; } return state.dailyLogs[dateStr]; }
        function loadDay(dateStr) { state.currentDateStr = dateStr; const log = ensureLog(dateStr); document.getElementById('daily-priorities').innerHTML = [1,2,3].map(n => `<div class="group flex items-center gap-3 p-4 glass-panel rounded-2xl ring-1 ring-white/5 transition-all"><input type="checkbox" ${log['p'+n+'_done'] ? 'checked' : ''} onchange="togglePriority(${n})" class="h-5 w-5 border-primary/50 bg-transparent text-primary rounded-full focus:ring-0"/><input type="text" class="dash-input text-sm flex-1 ${log['p'+n+'_done'] ? 'line-through opacity-40' : ''}" value="${log['p'+n] || ''}" placeholder="Prioridade ${n}..." oninput="updatePriorityText(${n}, this.value)"/></div>`).join(''); const fCont = document.getElementById('daily-flow'); const sortedTimes = Object.keys(log.timeline).sort(); fCont.innerHTML = sortedTimes.map(time => `<div class="relative group flex gap-4"><div class="absolute -left-[21px] top-0 h-2.5 w-2.5 rounded-full bg-primary shadow-[0_0_10px_#8c2bee]"></div><span class="text-[10px] text-primary font-bold w-12 font-mono pt-1">${time}</span><div class="flex-1 glass-panel rounded-2xl p-3 border-l-2 border-primary flex items-center gap-2"><input type="text" class="dash-input text-sm flex-1 text-white" value="${log.timeline[time]}" oninput="updateTimelineText('${time}', this.value)"/><button onclick="deleteTimelineSlot('${time}')" class="material-symbols-outlined text-[18px] text-white/30 hover:text-red-400">delete</button></div></div>`).join(''); document.getElementById('header-day-label').innerText = new Date(dateStr + "T12:00:00").toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'short' }).toUpperCase(); document.getElementById('daily-date').value = dateStr; resizeCanvas(); }
        function addTimelineSlotPrompt() { const t = prompt("Hora HH:MM"); if(t && /^([01]\d|2[0-3]):([0-5]\d)$/.test(t)) { ensureLog(state.currentDateStr).timeline[t] = ""; saveState(); loadDay(state.currentDateStr); } }
        function deleteTimelineSlot(t) { delete state.dailyLogs[state.currentDateStr].timeline[t]; saveState(); loadDay(state.currentDateStr); }

        function updateRadar() { if(!state) return; const log = ensureLog(state.currentDateStr); const todayISO = getLocalTodayISO(); const sbPrios = document.getElementById('sidebar-priorities-content'); if(sbPrios) { const list = [log.p1, log.p2, log.p3].filter(p => p && p.trim() !== ""); sbPrios.innerHTML = list.length > 0 ? list.map(p => `<div class="alert-card-sidebar text-xs text-white">${p}</div>`).join('') : '<p class="text-white/20 text-[10px]">Vazio.</p>'; } const container = document.getElementById('radar-container'); const upcoming = state.events.map(e => ({ ...e, diff: Math.ceil((new Date(e.date + "T12:00:00") - new Date(todayISO + "T12:00:00")) / 86400000) })).filter(e => e.diff >= 0).sort((a,b) => a.diff - b.diff); container.innerHTML = upcoming.slice(0, 5).map(ev => `<div class="neon-border-wrapper shrink-0"><div class="bg-[#251b2e] h-full rounded-xl p-4 min-w-[180px] flex gap-3 items-center relative group"><button onclick="deleteEvent(${ev.id})" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-[8px] text-white/40">DEL</button><div class="z-10"><p class="text-white text-xs font-bold uppercase truncate">${ev.desc}</p><p class="text-pink-300 text-[10px]">${ev.diff === 0 ? 'HOJE' : ev.diff + ' d'}</p></div></div></div>`).join('') || '<p class="text-white/20 text-[10px] px-4 font-bold uppercase">Limpo</p>'; const riskProj = state.projects.find(p => p.id === 'risk'); const sbRisks = document.getElementById('sidebar-risks-content'); if(sbRisks && riskProj) { sbRisks.innerHTML = riskProj.actions.filter(a => !a.done).map(a => `<div class="alert-card-sidebar" style="border-left-color: #ff7eb3"><p class="text-white text-xs">${a.text}</p></div>`).join('') || '<p class="text-white/20 text-[10px]">Tudo OK.</p>'; } }

        function renderProj() { const list = document.getElementById('projects-list'); list.innerHTML = state.projects.map(p => `<div class="glass-panel rounded-3xl p-5 border border-white/5 relative group"><div class="flex justify-between items-start mb-3"><div class="flex-1"><input type="text" class="dash-input font-bold text-base text-white" value="${p.title}" oninput="updateProjTitle('${p.id}', this.value)"/><p class="text-[9px] uppercase font-bold mt-1 text-white/40">ROADMAP ATIVO</p></div></div><div class="space-y-3 mt-4">${p.actions.map((a, idx) => `<div class="p-3 bg-white/5 rounded-2xl border border-white/5"><div class="flex items-center gap-3"><input type="checkbox" ${a.done ? 'checked' : ''} class="h-4 w-4 border-primary/40 bg-transparent text-primary rounded-full focus:ring-0" onchange="toggleAction('${p.id}', ${idx})"/><input type="text" class="dash-input text-[11px] flex-1 text-white ${a.done ? 'line-through opacity-30' : ''}" value="${a.text}" oninput="updateActionText('${p.id}', ${idx}, this.value)"/><button onclick="splitTask('${idx}')" class="text-[9px] bg-primary/20 text-primary px-2 py-1 rounded-lg border border-primary/30 font-black">DIVIDIR</button><button onclick="deleteAction('${p.id}', ${idx})" class="material-symbols-outlined text-[16px] text-white/20">delete</button></div>${a.phases && a.phases.length > 0 ? `<div class="mt-3 ml-7 pl-3 border-l border-white/10 space-y-2">${a.phases.map((ph, pIdx) => `<div class="flex items-center gap-2"><input type="checkbox" ${ph.done ? 'checked' : ''} onchange="togglePhase('${idx}', ${pIdx})" class="h-3 w-3 text-primary bg-transparent border-white/10 rounded-sm"/><input type="text" class="dash-input text-[10px] flex-1 text-white ${ph.done ? 'line-through opacity-30' : ''}" value="${ph.text}" oninput="updatePhaseText('${idx}', ${pIdx}, this.value)"/></div>`).join('')}<button onclick="addPhaseToTask('${idx}')" class="text-[8px] text-primary/60 font-bold uppercase">+ FASE</button></div>` : ''}</div>`).join('')}</div><button onclick="addAction('${p.id}')" class="mt-4 text-[9px] text-primary font-bold uppercase">+ Add Task</button></div>`).join(''); }

        function renderMonthly() { const grid = document.getElementById('month-grid'); const title = document.getElementById('month-title'); grid.innerHTML = ""; const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; title.innerText = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`; const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay(); const lastDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate(); const todayISO = getLocalTodayISO(); for (let i = 0; i < 42; i++) { const dayNum = i - firstDay + 1; const cell = document.createElement('div'); cell.className = "aspect-square glass-panel p-1 flex flex-col border border-white/5 relative cursor-pointer hover:bg-white/5"; if (dayNum > 0 && dayNum <= lastDate) { const currentISO = `${viewDate.getFullYear()}-${(viewDate.getMonth()+1).toString().padStart(2,'0')}-${dayNum.toString().padStart(2,'0')}`; cell.onclick = () => addEventPrompt(currentISO); cell.innerHTML = `<div class="calendar-day-num text-[10px] mb-1 ${currentISO === todayISO ? 'text-primary' : 'opacity-40'}">${dayNum}</div><div class="flex-1 overflow-y-auto hide-scrollbar space-y-1"></div>`; state.events.filter(e => e.date === currentISO).forEach(ev => { const item = document.createElement('div'); item.className = "bg-primary/20 text-[8px] p-1 rounded border border-primary/20 flex justify-between items-center"; item.innerHTML = `<span class="truncate pr-1 text-white">${ev.desc}</span><button onclick="event.stopPropagation(); deleteEvent(${ev.id})" class="material-symbols-outlined text-[10px] opacity-40">delete</button>`; cell.querySelector('div:last-child').appendChild(item); }); } else { cell.classList.add('opacity-0'); cell.style.pointerEvents = 'none'; } grid.appendChild(cell); } }
        function changeMonth(delta) { viewDate.setMonth(viewDate.getMonth() + delta); renderMonthly(); }

        function initContexts() { ['imp_urg', 'imp_not_urg', 'compras', 'casa'].forEach(k => { const el = document.getElementById('ctx-'+k); if(!el) return; el.innerHTML = (state.contexts[k] || []).map((item, idx) => `<div class="flex items-center gap-2 mb-2 p-2 bg-white/5 rounded-xl border border-white/5 transition-all"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleContextCheck('${k}', ${idx})" class="h-4 w-4 border-primary/40 bg-transparent text-primary rounded-full focus:ring-0"/><input type="text" class="dash-input text-[11px] flex-1 text-white ${item.done ? 'line-through opacity-30' : ''}" value="${item.text}" oninput="updateContextItem('${k}', ${idx}, this.value)"/><button onclick="deleteContextItem('${k}', ${idx})" class="text-white/20 text-xs hover:text-red-400">√ó</button></div>`).join(''); }); }
        function splitTask(idx) { const p = state.projects.find(proj => proj.id === 'risk'); if(!p.actions[idx].phases) p.actions[idx].phases = []; p.actions[idx].phases.push({ text: "Fase 1", done: false }); saveState(); renderProj(); }
        function addPhaseToTask(idx) { state.projects.find(p => p.id === 'risk').actions[idx].phases.push({text:"", done:false}); saveState(); renderProj(); }
        function updatePhaseText(idx, pIdx, val) { state.projects.find(p => p.id === 'risk').actions[idx].phases[pIdx].text = val; saveState(); }
        function togglePhase(idx, pIdx) { const ph = state.projects.find(p => p.id === 'risk').actions[idx].phases[pIdx]; ph.done = !ph.done; saveState(); renderProj(); }
        function toggleAction(pId, idx) { const p = state.projects.find(p => p.id === pId); p.actions[idx].done = !p.actions[idx].done; saveState(); renderProj(); }
        function updateActionText(pId, idx, val) { state.projects.find(p => p.id === pId).actions[idx].text = val; saveState(); }
        function deleteAction(pId, idx) { state.projects.find(p => p.id === pId).actions.splice(idx, 1); saveState(); renderProj(); }
        function updateProjTitle(id, val) { state.projects.find(p => p.id === id).title = val; saveState(); }
        function addNewProject() { state.projects.push({ id: 'p'+Date.now(), title: "Novo Objetivo", created: Date.now(), why: "", actions: [{text: "", done: false, phases:[]}] }); saveState(); renderProj(); }
        function addAction(pId) { state.projects.find(p => p.id === pId).actions.push({text: "", done: false, phases:[]}); saveState(); renderProj(); }
        function addContextItem(k) { state.contexts[k].push({text:"", done:false}); saveState(); initContexts(); }
        function toggleContextCheck(k, idx) { state.contexts[k][idx].done = !state.contexts[k][idx].done; saveState(); initContexts(); }
        function deleteContextItem(k, idx) { state.contexts[k].splice(idx, 1); saveState(); initContexts(); }
        function clearDoneContexts() { Object.keys(state.contexts).forEach(k => state.contexts[k] = state.contexts[k].filter(i => !i.done)); saveState(); initContexts(); }
        function togglePriority(n) { const log = ensureLog(state.currentDateStr); log['p'+n+'_done'] = !log['p'+n+'_done']; saveState(); loadDay(state.currentDateStr); }
        function updatePriorityText(n, val) { const log = ensureLog(state.currentDateStr); log['p'+n] = val; saveState(); }
        function updateTimelineText(time, val) { const log = ensureLog(state.currentDateStr); log.timeline[time] = val; saveState(); }
        function updateDumpText(v) { state.dump = v; saveState(); }
        function changeDay(delta) { const d = new Date(state.currentDateStr + "T12:00:00"); d.setDate(d.getDate() + delta); state.currentDateStr = d.toISOString().split('T')[0]; renderAll(); saveState(); }
        function loadDayFromInput() { loadDay(document.getElementById('daily-date').value); }
        function resetDaily() { if(confirm("Limpar dia?")) { state.dailyLogs[state.currentDateStr] = null; delete state.inkData[`ink_${state.currentDateStr}`]; renderAll(); saveState(); } }
        function addEventPrompt(date = null) { const d = date || prompt("AAAA-MM-DD"); const t = prompt("Evento:"); if(d && t) { state.events.push({date: d, desc: t, id: Date.now()}); saveState(); renderAll(); } }
        function deleteEvent(id) { state.events = state.events.filter(e => e.id !== id); saveState(); renderAll(); }
        function closeModal() { document.getElementById('modal').classList.replace('flex', 'hidden'); }
        function generateScreenshot() { saveDrawingToState(); html2canvas(document.getElementById('main-scroll-area'), { scale: 2, backgroundColor: "#191022", useCORS: true }).then(res => { document.getElementById('img-preview').src = res.toDataURL(); document.getElementById('dl-link').href = res.toDataURL(); document.getElementById('modal').classList.replace('hidden', 'flex'); }); }

        window.onload = () => { checkSession(); window.addEventListener('resize', resizeCanvas); };
    </script>
</body>
</html>
