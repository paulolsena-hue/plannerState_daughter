<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Planner Dashboard - Student Edition</title>
    
    <!-- Fontes e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8c2bee",
                        "background-dark": "var(--bg-color, #191022)",
                        "glass": "var(--glass-bg, rgba(255, 255, 255, 0.05))",
                        "glass-strong": "var(--glass-strong-bg, rgba(255, 255, 255, 0.1))",
                    },
                    fontFamily: { "display": ["Plus Jakarta Sans", "sans-serif"] },
                    backgroundImage: { 'dot-pattern': 'radial-gradient(var(--dot-color, rgba(255, 255, 255, 0.2)) 1px, transparent 1px)' },
                    backgroundSize: { 'dot-size': '20px 20px' }
                },
            },
        }
    </script>

    <style>
        :root { 
            --primary-color: #8c2bee; 
            --bg-color: #191022;
            --text-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --dot-color: rgba(255, 255, 255, 0.1);
            --nav-inactive: rgba(255, 255, 255, 0.4);
            color-scheme: dark; 
        }

        :root.light {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --dot-color: rgba(140, 43, 238, 0.1);
            --nav-inactive: rgba(30, 41, 59, 0.4);
            color-scheme: light;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light .glass-panel {
            border: 1px solid rgba(140, 43, 238, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .neon-border-wrapper {
            background: linear-gradient(45deg, #ff7eb3, var(--primary-color), #00d4ff);
            padding: 1px;
            border-radius: 0.75rem;
        }

        .view-content { display: none; height: auto; min-height: 100%; }
        .view-content.active { display: block; }

        input[type="checkbox"] { color: var(--primary-color) !important; border-color: rgba(140, 43, 238, 0.2); border-radius: 50%; }
        input[type="checkbox"]:focus { --tw-ring-color: var(--primary-color); }

        input[type="text"], input[type="date"], input[type="email"], input[type="password"], textarea {
            background-color: transparent !important;
            color: var(--text-color) !important;
            border: none;
            outline: none;
        }
        input::placeholder, textarea::placeholder { color: var(--text-color); opacity: 0.4; }

        .dash-input {
            background: transparent !important;
            border: none !important;
            border-bottom: 1px solid rgba(140, 43, 238, 0.1) !important;
            color: var(--text-color) !important;
            width: 100%;
            padding: 4px 0;
            outline: none;
        }

        .sidebar-transition { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        .alert-card-sidebar {
            background: var(--glass-bg);
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            border-radius: 0 12px 12px 0;
            margin-bottom: 10px;
        }

        .calendar-day-num { color: var(--text-color) !important; font-weight: 800; }

        .bottom-nav-transition { transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; }
        .nav-hidden { transform: translate(-50%, 150%) !important; opacity: 0; pointer-events: none; }
        .content-expanded { padding-bottom: 2rem !important; }

        #auth-overlay {
            position: fixed; inset: 0; background: var(--bg-color); z-index: 2000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-card { width: 100%; max-width: 400px; padding: 40px; border-radius: 32px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        #sync-indicator {
            position: fixed; top: 20px; right: 20px; z-index: 3000; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #sync-indicator.active { opacity: 1; }

        .theme-toggle-btn {
            width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; transition: all 0.3s;
        }

        .logo-img { width: 100%; height: 100%; object-fit: contain; }

        .nav-btn-inactive { color: var(--nav-inactive); }
    </style>
</head>

<body class="bg-background-dark font-display text-white antialiased selection:bg-primary selection:text-white overflow-hidden transition-colors duration-500">
    
    <!-- Sincroniza√ß√£o Status -->
    <div id="sync-indicator" class="flex items-center gap-2 bg-primary/20 backdrop-blur-xl px-3 py-1.5 rounded-full border border-primary/30">
        <span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>
        <span class="text-[9px] font-black uppercase tracking-widest text-primary">Nuvem Sync</span>
    </div>

    <!-- TELA DE LOGIN / CADASTRO -->
    <div id="auth-overlay">
        <div class="fixed inset-0 pointer-events-none z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[40%] rounded-full bg-primary/20 blur-[100px]"></div>
            <div class="absolute bottom-[20%] right-[-5%] w-[40%] h-[40%] rounded-full bg-pink-500/10 blur-[100px]"></div>
        </div>
        
        <div class="auth-card glass-panel relative z-10 text-center">
            <div class="mb-8 text-center">
                <!-- Logotipo Folha Minimalista Duotone -->
                <div class="h-24 w-24 ring-2 ring-primary/50 shadow-xl mx-auto mb-4 bg-background-dark/50 backdrop-blur-md rounded-full overflow-hidden flex items-center justify-center p-3">
                    <img src="https://api.iconify.design/solar:leaf-bold-duotone.svg?color=%238c2bee" class="logo-img" alt="Logotipo Folha"/>
                </div>
                <h2 class="text-2xl font-bold tracking-tight mb-2" style="color: var(--text-color)">Planner OS</h2>
                <p class="text-sm opacity-40 font-bold tracking-widest uppercase" style="color: var(--text-color)" id="auth-subtitle">Foco</p>
            </div>

            <div class="space-y-4" id="auth-form">
                <div class="text-left">
                    <label class="text-[10px] font-black text-primary uppercase ml-4 mb-1 block">Email</label>
                    <input type="email" id="email" placeholder="email@exemplo.com" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-primary/50 transition-all text-white"/>
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-black text-primary uppercase ml-4 mb-1 block">Senha</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-primary/50 transition-all text-white"/>
                </div>
                
                <button onclick="handleAuth()" id="main-auth-btn" class="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all mt-4">Entrar</button>
                
                <p class="text-xs opacity-40 mt-6" style="color: var(--text-color)">
                    <span id="auth-switch-text">N√£o tem uma conta?</span>
                    <button onclick="toggleAuthMode()" id="auth-switch-btn" class="text-primary font-bold ml-1 hover:underline">Cadastrar-se</button>
                </p>
            </div>
            <div id="auth-error" class="mt-4 text-xs text-rose-400 font-bold hidden"></div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-container" class="relative h-screen w-full flex flex-col hidden">
        <div class="fixed inset-0 pointer-events-none z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[40%] rounded-full bg-primary/20 blur-[100px]"></div>
            <div class="absolute bottom-[20%] right-[-5%] w-[40%] h-[40%] rounded-full bg-pink-500/10 blur-[100px]"></div>
            <div class="absolute inset-0 bg-dot-pattern bg-dot-size opacity-40"></div>
        </div>

        <!-- Sidebar HUD (Status Global) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0"></div>
        <aside id="sidebar" class="sidebar-transition fixed top-0 left-0 h-full w-[320px] bg-background-dark/95 backdrop-blur-2xl z-[80] transform -translate-x-full border-r border-white/5 p-6 overflow-y-auto hide-scrollbar shadow-2xl">
            <div class="flex justify-between items-center mb-8" style="color: var(--text-color)">
                <h2 class="text-xl font-bold tracking-tight">Status Global</h2>
                <div class="flex gap-2">
                    <button onclick="logout()" class="material-symbols-outlined text-sm opacity-50 hover:text-rose-400 transition-colors">logout</button>
                    <button onclick="toggleSidebar()" class="material-symbols-outlined opacity-50 transition-colors">close</button>
                </div>
            </div>
            <div class="space-y-8 pb-10">
                <section><p class="text-[10px] font-black text-primary uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-sm">target</span> Prioridades</p><div id="sidebar-priorities-content" class="space-y-3"></div></section>
                <section><p class="text-[10px] font-black text-pink-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-sm">event</span> Radar de Aten√ß√£o</p><div id="sidebar-radar-content" class="space-y-3"></div></section>
                <section><p class="text-[10px] font-black text-rose-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-sm">warning</span> Riscos</p><div id="sidebar-risks-content" class="space-y-3"></div></section>
                
                <section>
                    <p class="text-[10px] font-black text-amber-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">assignment_late</span> Pend√™ncias R√°pidas
                    </p>
                    <div id="sidebar-contexts-content" class="space-y-3"></div>
                </section>
            </div>
        </aside>

        <!-- Header -->
        <header class="relative z-50 flex p-6 items-center justify-between shrink-0">
            <div class="flex gap-4 items-center">
                <div class="relative">
                    <button onclick="toggleSidebar()" class="absolute -top-1 -left-1 z-10 bg-primary h-6 w-6 rounded-full flex items-center justify-center border-2 border-background-dark shadow-lg transition-transform active:scale-90"><span class="material-symbols-outlined text-[14px] text-white">menu</span></button>
                    <div class="h-14 w-14 ring-2 ring-primary/50 shadow-lg bg-background-dark/50 backdrop-blur-md rounded-full overflow-hidden flex items-center justify-center p-2">
                        <img src="https://api.iconify.design/solar:leaf-bold-duotone.svg?color=%238c2bee" class="logo-img" alt="Folha"/>
                    </div>
                </div>
                <div><p class="text-xs font-medium tracking-wider uppercase opacity-60" style="color: var(--text-color)" id="header-day-label">CARREGANDO...</p><p class="text-xl font-bold leading-tight" style="color: var(--text-color)">Planner OS</p></div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" class="theme-toggle-btn glass-panel transition-all hover:scale-110 active:scale-95" title="Mudar Tema">
                    <span class="material-symbols-outlined text-primary" id="theme-icon">dark_mode</span>
                </button>
                <button onclick="toggleBottomNav()" class="glass-panel p-3 rounded-full transition-all hover:bg-white/10 ring-1 ring-white/5"><span class="material-symbols-outlined" style="color: var(--text-color)" id="nav-toggle-icon">visibility</span></button>
            </div>
        </header>

        <!-- Radar Feed Horizontal -->
        <div class="relative z-10 flex flex-col gap-2 mb-2 shrink-0">
            <div class="px-6"><h3 class="text-[10px] font-bold tracking-[0.2em] flex items-center gap-2 opacity-90" style="color: var(--text-color)"><span class="material-symbols-outlined text-pink-400 text-[16px]">local_florist</span> ATTENTION RADAR</h3></div>
            <div class="flex overflow-x-auto hide-scrollbar px-6 py-2 gap-4 pb-4" id="radar-container"></div>
        </div>

        <!-- Main Viewport -->
        <div class="relative z-10 flex-1 glass-panel rounded-t-[2.5rem] mt-2 border-b-0 border-x-0 mx-2 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col overflow-hidden">
            <div class="absolute top-3 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-white/10 rounded-full z-50"></div>
            <div class="flex-1 overflow-y-auto hide-scrollbar px-6 pt-8 pb-32 relative transition-all duration-500" id="main-scroll-area">
                
                <!-- VIEW: DAILY -->
                <div id="view-daily" class="view-content active space-y-10 relative z-10">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 glass-panel px-3 py-1 rounded-full ring-1 ring-white/5">
                            <button onclick="changeDay(-1)" class="material-symbols-outlined text-sm" style="color: var(--text-color)">chevron_left</button>
                            <input type="date" id="daily-date" class="bg-transparent border-none text-[10px] font-bold p-0" style="color: var(--text-color)" onchange="loadDayFromInput()"/>
                            <button onclick="changeDay(1)" class="material-symbols-outlined text-sm" style="color: var(--text-color)">chevron_right</button>
                        </div>
                        <button onclick="resetDaily()" class="text-[9px] font-bold text-rose-400 uppercase tracking-widest hover:opacity-70">üóëÔ∏è Reiniciar Dia</button>
                    </div>
                    <section><h3 class="text-base font-bold flex items-center gap-2 mb-4" style="color: var(--text-color)"><span class="w-1.5 h-5 rounded-full bg-gradient-to-b from-primary to-pink-500 block"></span> Prioridades de Hoje</h3><div class="flex flex-col gap-3" id="daily-priorities"></div></section>
                    <section><div class="flex justify-between items-center mb-4"><h3 class="text-base font-bold flex items-center gap-2" style="color: var(--text-color)"><span class="w-1.5 h-5 rounded-full bg-gradient-to-b from-blue-500 to-cyan-400 block"></span> Cronograma Din√¢mico</h3><button onclick="addTimelineSlotPrompt()" class="bg-primary/20 text-primary text-[9px] px-4 py-1.5 rounded-full font-black border border-primary/30 uppercase tracking-widest transition-all hover:bg-primary/40">+ Adicionar Task</button></div><div class="relative pl-4 border-l border-primary/20 space-y-6" id="daily-flow"></div></section>
                </div>

                <!-- VIEW: CONTEXTS -->
                <div id="view-contexts" class="view-content space-y-8 relative z-10">
                    <div class="flex justify-between items-center text-white"><h3 class="text-lg font-bold flex items-center gap-2" style="color: var(--text-color)"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-pink-500 to-rose-600 block"></span> Listas de Contexto</h3><button onclick="clearDoneContexts()" class="text-[9px] font-bold text-primary uppercase tracking-widest">Limpar Feitos</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-rose-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üî• Urgente</p><div id="ctx-imp_urg" class="space-y-2"></div><button onclick="addContextItem('imp_urg')" class="mt-4 text-[10px] opacity-40 font-bold uppercase hover:opacity-100 transition-opacity" style="color: var(--text-color)">+ Novo</button></div>
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üìÖ Importante</p><div id="ctx-imp_not_urg" class="space-y-2"></div><button onclick="addContextItem('imp_not_urg')" class="mt-4 text-[10px] opacity-40 font-bold uppercase hover:opacity-100 transition-opacity" style="color: var(--text-color)">+ Novo</button></div>
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-blue-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üõçÔ∏è Compras</p><div id="ctx-compras" class="space-y-2"></div><button onclick="addContextItem('compras')" class="mt-4 text-[10px] opacity-40 font-bold uppercase hover:opacity-100 transition-opacity" style="color: var(--text-color)">+ Novo</button></div>
                        <div class="glass-panel p-5 rounded-3xl border border-white/5"><p class="text-emerald-400 text-[10px] font-black uppercase tracking-[0.2em] mb-4">üè† Pessoal</p><div id="ctx-casa" class="space-y-2"></div><button onclick="addContextItem('casa')" class="mt-4 text-[10px] opacity-40 font-bold uppercase hover:opacity-100 transition-opacity" style="color: var(--text-color)">+ Novo</button></div>
                    </div>
                </div>

                <!-- VIEW: PROJECTS -->
                <div id="view-projects" class="view-content space-y-8 relative z-10 text-white"><h3 class="text-lg font-bold flex items-center gap-2" style="color: var(--text-color)"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-yellow-400 to-orange-500 block"></span> Roadmap 2026</h3><div id="projects-list" class="space-y-3"></div><button onclick="addNewProject()" class="w-full py-4 rounded-2xl border border-dashed border-primary/30 text-primary text-xs font-bold hover:bg-primary/5 transition-all uppercase tracking-widest">+ Novo Objetivo</button></div>

                <!-- VIEW: BRAIN DUMP -->
                <div id="view-dump" class="view-content relative z-10 text-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2" style="color: var(--text-color)"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-green-400 to-emerald-600 block"></span> Brain Dump</h3>
                        <div class="flex gap-2">
                            <button onclick="clearDump()" class="p-2 glass-panel rounded-xl hover:bg-rose-500/20 text-rose-400 transition-all flex items-center gap-1 text-[10px] font-bold uppercase"><span class="material-symbols-outlined text-[18px]">auto_fix_high</span> Limpar</button>
                            <button onclick="archiveDump()" class="p-2 glass-panel rounded-xl hover:bg-primary/20 text-primary transition-all flex items-center gap-1 text-[10px] font-bold uppercase"><span class="material-symbols-outlined text-[18px]">archive</span> Arquivar</button>
                        </div>
                    </div>
                    <div class="w-full h-80 bg-white/5 rounded-3xl p-6 border border-white/10 bg-dot-pattern bg-dot-size relative group">
                        <textarea id="brain-dump-text" class="w-full h-full bg-transparent border-none resize-none focus:ring-0 text-sm leading-relaxed" style="color: var(--text-color)" placeholder="Anote pensamentos..." oninput="updateDumpText(this.value)"></textarea>
                    </div>
                    <div class="mt-8 space-y-4"><p class="text-[10px] font-black opacity-40 uppercase tracking-[0.2em] px-2" style="color: var(--text-color)">Hist√≥rico de Registros</p><div id="dump-history-list" class="space-y-3"></div></div>
                </div>

                <!-- VIEW: MONTHLY -->
                <div id="view-monthly" class="view-content space-y-6 relative z-10 text-white">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold flex items-center gap-2" style="color: var(--text-color)"><span class="w-1.5 h-6 rounded-full bg-gradient-to-b from-pink-500 to-rose-600 block"></span> Agenda Mensal</h3>
                        <div class="flex items-center gap-4 bg-white/5 px-4 py-2 rounded-full border border-white/10">
                            <button onclick="changeMonth(-1)" class="material-symbols-outlined hover:text-primary transition-colors" style="color: var(--text-color)">chevron_left</button>
                            <span id="month-title" class="text-sm font-black uppercase tracking-widest min-w-[150px] text-center" style="color: var(--text-color)">---</span>
                            <button onclick="changeMonth(1)" class="material-symbols-outlined hover:text-primary transition-colors" style="color: var(--text-color)">chevron_right</button>
                        </div>
                    </div>
                    <div id="month-header" class="grid grid-cols-7 gap-1" style="color: var(--text-color)">
                        <div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Dom</div><div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Seg</div><div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Ter</div><div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Qua</div><div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Qui</div><div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Sex</div><div class="text-center text-[10px] font-black opacity-30 p-2 uppercase">Sab</div>
                    </div>
                    <div id="month-grid" class="grid grid-cols-7 gap-1 border border-white/10 rounded-2xl overflow-hidden shadow-2xl"></div>
                </div>
            </div>
        </div>

        <!-- Navigation Flutuante -->
        <nav id="bottom-nav" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[60] bottom-nav-transition">
            <div class="glass-panel rounded-3xl p-2 flex justify-between items-center shadow-2xl shadow-primary/30 ring-1 ring-white/10">
                <button onclick="nav('daily')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl transition-all nav-btn-inactive" id="btn-daily"><span class="material-symbols-outlined text-[20px]">calendar_view_day</span><span class="text-[9px] font-bold uppercase tracking-tighter">Di√°rio</span></button>
                <button onclick="nav('contexts')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl nav-btn-inactive" id="btn-contexts"><span class="material-symbols-outlined text-[20px]">list_alt</span><span class="text-[9px] font-bold uppercase tracking-tighter">Listas</span></button>
                <div class="relative -top-8 mx-2"><button onclick="nav('dump')" class="h-16 w-16 rounded-full bg-gradient-to-tr from-pink-500 to-primary flex items-center justify-center shadow-2xl border-4 border-background-dark hover:scale-105 transition-all"><span class="material-symbols-outlined text-white text-[32px]">psychology</span></button></div>
                <button onclick="nav('projects')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl nav-btn-inactive" id="btn-projects"><span class="material-symbols-outlined text-[20px]">rocket_launch</span><span class="text-[9px] font-bold uppercase tracking-tighter">Roadmap</span></button>
                <button onclick="nav('monthly')" class="nav-btn flex-1 flex flex-col items-center gap-1 py-2.5 rounded-2xl nav-btn-inactive" id="btn-monthly"><span class="material-symbols-outlined text-[20px]">calendar_month</span><span class="text-[9px] font-bold uppercase tracking-tighter">Agenda</span></button>
            </div>
        </nav>
    </div>

    <script>
        const SUPABASE_URL = "https://xmbydwfxkbpcjmojtyvk.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_9cmC_iJS5VL6j_W_CetgXw_k-pf5gii";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let isSignUpMode = false;
        let state = null;
        let viewDate = new Date();
        let saveTimeout = null;

        // THEME LOGIC
        function toggleTheme() {
            const isLight = !document.documentElement.classList.contains('light');
            state.theme_mode = isLight ? 'light' : 'dark';
            applyThemeProperties();
            saveState();
            renderAll();
        }

        function applyThemeProperties() {
            const isLight = state.theme_mode === 'light';
            const icon = document.getElementById('theme-icon');
            if(isLight) {
                document.documentElement.style.setProperty('--bg-color', '#f1f5f9');
                document.documentElement.style.setProperty('--text-color', '#1e293b');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.7)');
                document.documentElement.style.setProperty('--dot-color', 'rgba(140, 43, 238, 0.05)');
                document.documentElement.style.setProperty('--nav-inactive', 'rgba(30, 41, 59, 0.4)');
                document.documentElement.classList.add('light');
                document.documentElement.classList.remove('dark');
                icon.innerText = 'light_mode';
            } else {
                document.documentElement.style.setProperty('--bg-color', '#191022');
                document.documentElement.style.setProperty('--text-color', '#ffffff');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(255, 255, 255, 0.03)');
                document.documentElement.style.setProperty('--dot-color', 'rgba(255, 255, 255, 0.1)');
                document.documentElement.style.setProperty('--nav-inactive', 'rgba(255, 255, 255, 0.4)');
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                icon.innerText = 'dark_mode';
            }
        }

        // AUTH
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');
            if(!email || !password) { showAuthError("Preencha todos os campos"); return; }
            let result;
            if(isSignUpMode) result = await supabaseClient.auth.signUp({ email, password });
            else result = await supabaseClient.auth.signInWithPassword({ email, password });
            if(result.error) showAuthError(result.error.message);
            else if(isSignUpMode && !result.data.session) { alert("Verifique seu e-mail!"); toggleAuthMode(); }
            else checkSession();
        }
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('main-auth-btn').innerText = isSignUpMode ? "Criar Conta" : "Entrar";
            document.getElementById('auth-subtitle').innerText = isSignUpMode ? "Crie seu acesso pessoal" : "Dashboard do Planner OS";
        }
        function showAuthError(msg) { const errorEl = document.getElementById('auth-error'); errorEl.innerText = msg; errorEl.classList.remove('hidden'); }
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if(session) { currentUser = session.user; document.getElementById('auth-overlay').style.display = 'none'; document.getElementById('app-container').classList.remove('hidden'); await initApp(); }
            else { document.getElementById('auth-overlay').style.display = 'flex'; document.getElementById('app-container').classList.add('hidden'); }
        }
        async function logout() { await supabaseClient.auth.signOut(); location.reload(); }

        // CORE STATE
        function getLocalTodayISO() { const now = new Date(); const offset = now.getTimezoneOffset(); return new Date(now.getTime() - (offset * 60 * 1000)).toISOString().split('T')[0]; }
        async function initApp() {
            if(!currentUser) return;
            document.getElementById('header-day-label').innerText = "SINCRONIZANDO...";
            const { data } = await supabaseClient.from('user_settings').select('full_state').eq('user_id', currentUser.id).single();
            if (data && data.full_state) { 
                state = data.full_state; state.currentDateStr = getLocalTodayISO();
                applyThemeProperties();
            } else {
                state = { theme_mode: 'dark', activeView: 'daily', events: [], projects: [{ id: 'risk', title: "Risco Procrastina√ß√£o", created: Date.now(), actions: [] }], currentDateStr: getLocalTodayISO(), dailyLogs: {}, dump: "", dumpHistory: [], contexts: { casa:[], compras:[], adm:[], imp_urg:[], imp_not_urg:[] } };
            }
            if(!state.dumpHistory) state.dumpHistory = [];
            if(!state.projects) state.projects = [];
            if(!state.contexts) state.contexts = { casa:[], compras:[], adm:[], imp_urg:[], imp_not_urg:[] };
            lucide.createIcons();
            renderAll();
        }
        async function saveState() {
            if(!currentUser || !state) return;
            document.getElementById('sync-indicator').classList.add('active');
            if(saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                await supabaseClient.from('user_settings').upsert({ user_id: currentUser.id, full_state: state, updated_at: new Date() });
                document.getElementById('sync-indicator').classList.remove('active');
                updateRadar();
            }, 800);
        }

        // NAVIGATION
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay'); if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); setTimeout(() => ov.classList.add('opacity-100'), 10); updateRadar(); } else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); ov.classList.remove('opacity-100'); } }
        function toggleBottomNav() { const isHidden = document.getElementById('bottom-nav').classList.toggle('nav-hidden'); document.getElementById('main-scroll-area').classList.toggle('content-expanded', isHidden); document.getElementById('nav-toggle-icon').innerText = isHidden ? "visibility_off" : "visibility"; }
        function nav(viewId) { 
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active')); 
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white', 'shadow-lg'); b.classList.add('nav-btn-inactive'); }); 
            document.getElementById('view-' + viewId).classList.add('active'); 
            const btn = document.getElementById('btn-' + viewId); 
            if(btn) { btn.classList.remove('nav-btn-inactive'); btn.classList.add('bg-primary', 'text-white', 'shadow-lg'); } 
            state.activeView = viewId; 
            renderAll(); 
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
        }

        // BRAIN DUMP
        function updateDumpText(v) { state.dump = v; saveState(); }
        function clearDump() { if(confirm("Limpar anota√ß√£o atual?")) { state.dump = ""; document.getElementById('brain-dump-text').value = ""; saveState(); } }
        function archiveDump() { if(!state.dump) return; state.dumpHistory.unshift({ id: Date.now(), text: state.dump, time: new Date().toLocaleString('pt-BR') }); state.dump = ""; document.getElementById('brain-dump-text').value = ""; saveState(); renderDumpHistory(); }
        function deleteHistoryItem(id) { state.dumpHistory = state.dumpHistory.filter(h => h.id !== id); saveState(); renderDumpHistory(); }
        function renderDumpHistory() { const list = document.getElementById('dump-history-list'); if(!list) return; list.innerHTML = (state.dumpHistory || []).map(h => `<div class="glass-panel p-4 rounded-2xl border border-white/5 group relative"><div class="flex justify-between items-start mb-2"><span class="text-[9px] font-black text-primary uppercase tracking-widest">${h.time}</span><button onclick="deleteHistoryItem(${h.id})" class="material-symbols-outlined text-[16px] opacity-40 hover:opacity-100 transition-all" style="color: var(--text-color)">delete</button></div><p class="text-xs opacity-70 whitespace-pre-wrap" style="color: var(--text-color)">${h.text}</p></div>`).join('') || '<p class="text-white/20 text-[10px] text-center">Vazio.</p>'; }

        // ROADMAP
        function renderProj() { const list = document.getElementById('projects-list'); if(!list) return; list.innerHTML = (state.projects || []).map(p => `<div class="glass-panel rounded-3xl p-5 border border-white/5 relative group"><div class="flex justify-between mb-3"><div><input type="text" class="dash-input font-bold text-base" style="color: var(--text-color)" value="${p.title}" oninput="updateProjTitle('${String(p.id)}', this.value)"/><p class="text-[9px] uppercase font-bold opacity-40" style="color: var(--text-color)">ROADMAP ATIVO</p></div><button onclick="deleteProject('${String(p.id)}')" class="material-symbols-outlined opacity-30 hover:opacity-100" style="color: var(--text-color)">delete</button></div><div class="space-y-3 mt-4">${(p.actions || []).map((a, idx) => `<div class="p-3 bg-white/5 rounded-2xl border border-white/5 flex flex-col gap-2"><div class="flex items-center gap-3"><input type="checkbox" ${a.done ? 'checked' : ''} onchange="toggleAction('${String(p.id)}', ${idx})" class="h-4 w-4 text-primary rounded-full"/><input type="text" class="dash-input text-[11px] flex-1 text-white ${a.done ? 'line-through opacity-30' : ''}" value="${a.text}" oninput="updateActionText('${String(p.id)}', ${idx}, this.value)"/>${p.id === 'risk' ? `<button onclick="splitTask('${idx}')" class="text-[9px] bg-primary/20 text-primary px-2 py-1 rounded-lg">DIVIDIR</button>` : ''}<button onclick="deleteAction('${String(p.id)}', ${idx})" class="material-symbols-outlined text-[16px] opacity-30" style="color: var(--text-color)">delete</button></div>${a.phases && a.phases.length > 0 ? `<div class="ml-7 pl-3 border-l border-primary/20 space-y-2">${a.phases.map((ph, pIdx) => `<div class="flex items-center gap-2"><input type="checkbox" ${ph.done ? 'checked' : ''} onchange="togglePhase('${idx}', ${pIdx})" class="h-3 w-3 text-primary"/><input type="text" class="dash-input text-[10px] flex-1 text-white ${ph.done ? 'line-through opacity-30' : ''}" value="${ph.text}" oninput="updatePhaseText('${idx}', ${pIdx}, this.value)"/></div>`).join('')}<button onclick="addPhaseToTask('${idx}')" class="text-[8px] text-primary/60 font-bold uppercase transition-all hover:opacity-100">+ FASE</button></div>` : ''}</div>`).join('')}</div><button onclick="addAction('${String(p.id)}')" class="mt-4 text-[9px] text-primary font-bold">+ Add Task</button></div>`).join(''); }
        function addAction(pId) { const project = state.projects.find(p => String(p.id) === String(pId)); if(project) { if(!project.actions) project.actions = []; project.actions.push({text: "", done: false, phases:[]}); saveState(); renderProj(); } }
        function addNewProject() { const newId = 'p' + Date.now(); state.projects.push({ id: newId, title: "Novo Objetivo", created: Date.now(), actions: [] }); saveState(); renderProj(); }
        function deleteProject(id) { if(confirm("Apagar?") && id !== 'risk') { state.projects = state.projects.filter(p => String(p.id) !== String(id)); saveState(); renderProj(); } }
        function updateProjTitle(id, val) { const p = state.projects.find(p => String(p.id) === String(id)); if(p) { p.title = val; saveState(); } }
        function toggleAction(pId, idx) { const p = state.projects.find(p => String(p.id) === String(pId)); if(p) { p.actions[idx].done = !p.actions[idx].done; saveState(); renderProj(); } }
        function updateActionText(pId, idx, val) { const p = state.projects.find(p => String(p.id) === String(pId)); if(p) { p.actions[idx].text = val; saveState(); } }
        function deleteAction(pId, idx) { const p = state.projects.find(p => String(p.id) === String(pId)); if(p) { p.actions.splice(idx, 1); saveState(); renderProj(); } }
        function splitTask(idx) { const p = state.projects.find(proj => proj.id === 'risk'); if(p) { if(!p.actions[idx].phases) p.actions[idx].phases = []; p.actions[idx].phases.push({ text: "Fase 1", done: false }); saveState(); renderProj(); } }
        function addPhaseToTask(idx) { const p = state.projects.find(p => p.id === 'risk'); if(p) { p.actions[idx].phases.push({text:"", done:false}); saveState(); renderProj(); } }
        function updatePhaseText(idx, pIdx, val) { const p = state.projects.find(p => p.id === 'risk'); if(p) p.actions[idx].phases[pIdx].text = val; saveState(); }
        function togglePhase(idx, pIdx) { const p = state.projects.find(p => p.id === 'risk'); if(p) { const ph = p.actions[idx].phases[pIdx]; ph.done = !ph.done; saveState(); renderProj(); } }

        // DAILY
        function ensureLog(dateStr) { if (!state.dailyLogs[dateStr]) { state.dailyLogs[dateStr] = { p1: "", p1_done: false, p2: "", p2_done: false, p3: "", p3_done: false, timeline: { "12:00": "Almo√ßo", "23:00": "Descanso" } }; } return state.dailyLogs[dateStr]; }
        function loadDay(dateStr) { state.currentDateStr = dateStr; const log = ensureLog(dateStr); document.getElementById('daily-priorities').innerHTML = [1,2,3].map(n => `<div class="group flex items-center gap-3 p-4 glass-panel rounded-2xl ring-1 ring-white/5 transition-all"><input type="checkbox" ${log['p'+n+'_done'] ? 'checked' : ''} onchange="togglePriority(${n})" class="h-5 w-5 text-primary rounded-full"/><input type="text" class="dash-input text-sm flex-1 text-white ${log['p'+n+'_done'] ? 'line-through opacity-40' : ''}" value="${log['p'+n] || ''}" placeholder="Prioridade ${n}..." oninput="updatePriorityText(${n}, this.value)"/></div>`).join(''); const sortedTimes = Object.keys(log.timeline).sort(); document.getElementById('daily-flow').innerHTML = sortedTimes.map(time => `<div class="relative group flex gap-4"><div class="absolute -left-[21px] top-0 h-2.5 w-2.5 rounded-full bg-primary shadow-[0_0:10px_#8c2bee]"></div><span class="text-[10px] text-primary font-bold w-12 font-mono pt-1 text-white">${time}</span><div class="flex-1 glass-panel rounded-2xl p-3 border-l-2 border-primary flex items-center gap-2"><input type="text" class="dash-input text-sm flex-1 text-white" value="${log.timeline[time]}" oninput="updateTimelineText('${time}', this.value)"/><button onclick="deleteTimelineSlot('${time}')" class="material-symbols-outlined text-[18px] opacity-30 hover:text-red-400" style="color: var(--text-color)">delete</button></div></div>`).join(''); document.getElementById('header-day-label').innerText = new Date(dateStr + "T12:00:00").toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'short' }).toUpperCase(); document.getElementById('daily-date').value = dateStr; }
        function updatePriorityText(n, v) { ensureLog(state.currentDateStr)['p'+n] = v; saveState(); }
        function togglePriority(n) { const l = ensureLog(state.currentDateStr); l['p'+n+'_done'] = !l['p'+n+'_done']; saveState(); loadDay(state.currentDateStr); }
        function updateTimelineText(t, v) { ensureLog(state.currentDateStr).timeline[t] = v; saveState(); }
        function addTimelineSlotPrompt() { const t = prompt("Hora HH:MM"); if(t && /^([01]\d|2[0-3]):([0-5]\d)$/.test(t)) { ensureLog(state.currentDateStr).timeline[t] = ""; saveState(); loadDay(state.currentDateStr); } }
        function deleteTimelineSlot(t) { delete state.dailyLogs[state.currentDateStr].timeline[t]; saveState(); loadDay(state.currentDateStr); }
        function loadDayFromInput() { loadDay(document.getElementById('daily-date').value); }
        function resetDaily() { if(confirm("Limpar dia?")) { state.dailyLogs[state.currentDateStr] = { p1: "", p1_done: false, p2: "", p2_done: false, p3: "", p3_done: false, timeline: { "12:00": "Almo√ßo", "23:00": "Descanso" } }; saveState(); renderAll(); } }

        // Radar e Sidebar
        function updateRadar() {
            if(!state) return;
            const log = ensureLog(state.currentDateStr);
            const todayISO = getLocalTodayISO();
            const sbPrios = document.getElementById('sidebar-priorities-content');
            const list = [log.p1, log.p2, log.p3].filter(p => p && p.trim() !== "");
            sbPrios.innerHTML = list.length > 0 ? list.map(p => `<div class="alert-card-sidebar text-xs" style="color: var(--text-color)">${p}</div>`).join('') : '<p class="text-[10px] opacity-30" style="color: var(--text-color)">Sem metas definidas.</p>';

            const today = new Date(todayISO + "T12:00:00");
            const alertsOnly = state.events.filter(e => e.alert).map(e => ({ ...e, diff: Math.ceil((new Date(e.date + "T12:00:00") - today) / 86400000) })).filter(e => e.diff >= 0).sort((a,b) => a.diff - b.diff);
            
            const container = document.getElementById('radar-container');
            container.innerHTML = alertsOnly.slice(0, 5).map(ev => `<div class="neon-border-wrapper shrink-0"><div class="bg-[#251b2e] h-full rounded-xl p-4 min-w-[180px] flex gap-3 items-center relative group"><button onclick="deleteEvent(${ev.id})" class="absolute top-2 right-2 text-[8px] text-white/40">DEL</button><div class="z-10"><p class="text-white text-xs font-bold uppercase truncate">${ev.desc}</p><p class="text-pink-300 text-[10px]">${ev.diff === 0 ? 'HOJE' : ev.diff + ' d'}</p></div></div></div>`).join('') || '<p class="text-[10px] px-4 opacity-30" style="color: var(--text-color)">SEM ALERTAS ATIVOS</p>';
            
            const sbRadar = document.getElementById('sidebar-radar-content');
            sbRadar.innerHTML = alertsOnly.map(ev => `<div class="alert-card-sidebar"><p class="text-xs font-bold" style="color: var(--text-color)">${ev.desc}</p><p class="text-primary text-[9px] mt-1 font-black">${ev.diff === 0 ? 'HOJE' : 'em ' + ev.diff + ' dias'}</p></div>`).join('') || '<p class="text-[10px] opacity-30" style="color: var(--text-color)">Sem eventos.</p>';

            const riskProj = state.projects.find(p => p.id === 'risk');
            const sbRisks = document.getElementById('sidebar-risks-content');
            if(sbRisks && riskProj) { sbRisks.innerHTML = (riskProj.actions || []).filter(a => !a.done).map(a => `<div class="alert-card-sidebar" style="border-left-color: #ff7eb3"><p class="text-xs" style="color: var(--text-color)">${a.text}</p></div>`).join('') || '<p class="text-[10px] opacity-30" style="color: var(--text-color)">Tudo OK.</p>'; }

            const sbContexts = document.getElementById('sidebar-contexts-content');
            const urgents = (state.contexts.imp_urg || []).filter(i => !i.done).map(i => ({text: i.text, cat: 'üî•'}));
            const compras = (state.contexts.compras || []).filter(i => !i.done).map(i => ({text: i.text, cat: 'üõçÔ∏è'}));
            const combined = [...urgents, ...compras];
            
            sbContexts.innerHTML = combined.map(i => `
                <div class="alert-card-sidebar" style="border-left-color: ${i.cat === 'üî•' ? '#f59e0b' : '#3b82f6'}">
                    <p class="text-[10px] font-bold text-white opacity-40 uppercase mb-1">${i.cat === 'üî•' ? 'Urgente' : 'Compra'}</p>
                    <p class="text-xs font-medium" style="color: var(--text-color)">${i.text}</p>
                </div>
            `).join('') || '<p class="text-[10px] opacity-30" style="color: var(--text-color)">Nada pendente.</p>';
        }

        // Agenda
        function renderMonthly() {
            const grid = document.getElementById('month-grid');
            const title = document.getElementById('month-title');
            if(!grid || !title) return;
            grid.innerHTML = "";
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            title.innerText = `${monthNames[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
            const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            const lastDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const todayISO = getLocalTodayISO();

            for (let i = 0; i < 42; i++) {
                const dayNum = i - firstDay + 1;
                const cell = document.createElement('div');
                cell.className = "aspect-square glass-panel p-1 flex flex-col border border-white/5 relative cursor-pointer hover:bg-white/5 transition-all";
                if (dayNum > 0 && dayNum <= lastDate) {
                    const currentISO = `${viewDate.getFullYear()}-${(viewDate.getMonth()+1).toString().padStart(2,'0')}-${dayNum.toString().padStart(2,'0')}`;
                    cell.onclick = () => addEventPrompt(currentISO);
                    cell.innerHTML = `<div class="calendar-day-num text-[10px] mb-1 ${currentISO === todayISO ? 'text-primary' : 'opacity-40'}">${dayNum}</div><div class="flex-1 overflow-y-auto hide-scrollbar space-y-1"></div>`;
                    state.events.filter(e => e.date === currentISO).forEach(ev => {
                        const item = document.createElement('div');
                        item.className = `${ev.alert ? 'bg-pink-500/30 border-pink-500/40' : 'bg-primary/20 border-primary/20'} text-[8px] p-1 rounded border flex justify-between items-center`;
                        item.innerHTML = `<span class="truncate pr-1 text-white flex items-center gap-1" style="color: var(--text-color)">${ev.alert ? '<span class="material-symbols-outlined text-[10px] text-pink-400">notifications_active</span>' : ''}${ev.desc}</span><button onclick="event.stopPropagation(); deleteEvent(${ev.id})" class="material-symbols-outlined text-[10px] opacity-30 hover:opacity-100" style="color: var(--text-color)">delete</button>`;
                        cell.querySelector('div:last-child').appendChild(item);
                    });
                } else { cell.classList.add('opacity-0'); cell.style.pointerEvents = 'none'; }
                grid.appendChild(cell);
            }
        }
        function changeMonth(delta) { viewDate.setMonth(viewDate.getMonth() + delta); renderMonthly(); }
        function addEventPrompt(date) {
            const desc = prompt("Evento para o dia?"); if(!desc) return;
            const isAlert = confirm("Marcar como ALERTA no Status Global?");
            state.events.push({ id: Date.now(), date, desc, alert: isAlert });
            saveState(); renderMonthly();
        }
        function deleteEvent(id) { if(confirm("Apagar evento?")) { state.events = state.events.filter(e => e.id !== id); saveState(); renderMonthly(); } }

        // Contextos
        function initContexts() { ['imp_urg', 'imp_not_urg', 'compras', 'casa'].forEach(k => { const el = document.getElementById('ctx-'+k); if(!el) return; el.innerHTML = (state.contexts[k] || []).map((item, idx) => `<div class="flex items-center gap-2 mb-2 p-2 bg-white/5 rounded-xl border border-white/5 transition-all"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleContextCheck('${k}', ${idx})" class="h-4 w-4 border-primary/40 bg-transparent text-primary rounded-full"/><input type="text" class="dash-input text-[11px] flex-1 text-white ${item.done ? 'line-through opacity-30' : ''}" value="${item.text}" oninput="updateContextItem('${k}', ${idx}, this.value)"/><button onclick="deleteContextItem('${k}', ${idx})" class="material-symbols-outlined text-xs opacity-30" style="color: var(--text-color)">close</button></div>`).join(''); }); }
        function addContextItem(k) { state.contexts[k].push({text:"", done:false}); saveState(); initContexts(); updateRadar(); }
        function updateContextItem(k, idx, val) { state.contexts[k][idx].text = val; saveState(); }
        function toggleContextCheck(k, idx) { state.contexts[k][idx].done = !state.contexts[k][idx].done; saveState(); initContexts(); updateRadar(); }
        function deleteContextItem(k, idx) { state.contexts[k].splice(idx, 1); saveState(); initContexts(); updateRadar(); }
        function clearDoneContexts() { Object.keys(state.contexts).forEach(k => state.contexts[k] = state.contexts[k].filter(i => !i.done)); saveState(); initContexts(); updateRadar(); }

        function renderAll() {
            if(!state) return;
            const view = state.activeView;
            if(view === 'daily') loadDay(state.currentDateStr);
            else if(view === 'projects') renderProj();
            else if(view === 'monthly') renderMonthly();
            else if(view === 'contexts') initContexts();
            else if(view === 'dump') { document.getElementById('brain-dump-text').value = state.dump || ""; renderDumpHistory(); }
            updateRadar();
        }

        window.onload = () => { checkSession(); window.addEventListener('resize', () => { if(state) renderProj(); }); };
    </script>
</body>
</html>
